#include "ShadowsLogic.h"
#include <spdlog/sinks/basic_file_sink.h>

using namespace std::literals;

namespace {
void InitializeLog() {
  auto path = SKSE::log::log_directory();
  if (!path) {
    return;
  }

  *path /= "SkyrimSE_Plugin_Project.log";
  auto sink =
      std::make_shared<spdlog::sinks::basic_file_sink_mt>(path->string(), true);

  auto log = std::make_shared<spdlog::logger>("global log"s, std::move(sink));

  log->set_level(spdlog::level::info);
  log->flush_on(spdlog::level::info);

  spdlog::set_default_logger(std::move(log));
  spdlog::set_pattern("[%H:%M:%S.%e] [%n] [%l] %v"s);
}

void OnMessaging(SKSE::MessagingInterface::Message *a_msg) {
  switch (a_msg->type) {
  case SKSE::MessagingInterface::kDataLoaded:
    ShadowsLogic::GetSingleton()->Install();
    break;
  case SKSE::MessagingInterface::kPostLoadGame:
    ShadowsLogic::GetSingleton()->CheckAndAddSpell();
    break;
  }
}
} // namespace

extern "C" __declspec(dllexport) bool SKSEAPI
SKSEPlugin_Query(const SKSE::QueryInterface *a_skse, SKSE::PluginInfo *a_info) {
  a_info->infoVersion = SKSE::PluginInfo::kVersion;
  a_info->name = "SkyrimSE_Plugin_Project";
  a_info->version = 1;

  if (a_skse->IsEditor()) {
    SKSE::log::critical("Loaded in editor, marking as incompatible"sv);
    return false;
  }

  const auto ver = a_skse->RuntimeVersion();
  if (ver < REL::Version(1, 5, 39, 0)) {
    SKSE::log::critical(FMT_STRING("Unsupported runtime version {}"),
                        ver.string());
    return false;
  }

  return true;
}

extern "C" __declspec(dllexport) bool SKSEAPI
SKSEPlugin_Load(const SKSE::LoadInterface *a_skse) {
  InitializeLog();
  SKSE::log::info("SkyrimSE_Plugin_Project loaded");

  SKSE::Init(a_skse);

  auto messaging = SKSE::GetMessagingInterface();
  if (messaging) {
    messaging->RegisterListener(OnMessaging);
  }

  return true;
}
